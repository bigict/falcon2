{% extends "layout.html" %}

{% block title %}server - Profold checking {% endblock %}

{% block meta %}
{{ super() }}

{% if task.status != "Done" %}
<meta http-equiv="refresh" content="{{ refresh | default(30) }}" >
{% endif %}

{% endblock %}

{% block content %}

<div class="zerif_full_site_wrap"><div class="fadein-slider"><div class="slide-item" style="background:#fff"></div></div><div class="zerif_full_site">
<section id="home"  style="color:rgba(0,0,0,0.8); text-align:justify">
    <div class="overlay" style="background:#fff;padding-top: 8px;padding-bottom: 3px;">
        <div class="container" style="background:#fff;" >
            <div class="row">
                <div class="col-md-8 wow fadeIn"  data-wow-delay="0.3s">

        
        <h2>FALCON<big>2</big>/ProFold - Checking</h2>

        <!-- Specifications of the Job -->
        <div class="block">
            <table>
                <tr><th bgcolor="#33ccff"><h4><font color="white">&nbsp Task information</font></h4></th></tr>
            </table>
{% if task %}
<!--
            <div class="row">
                <div class="left" style="text-align: left; position: absolute;"><label>Job ID: </label> </div>
                <div class='right' style='right: 100px; position: relative'>
                    <select id="job_select" style="font-size:100%">
                    <option selected>{{ task.job_id }}</option>
                    </select>
                    &nbsp;&nbsp;<a href="">Resubmit</a>这个按钮的函数要改，和原代码逻辑不同
                </div>
            -->         
            <div class="row">
                <div class="left" style="text-align: left; position: absolute;"><label>Job ID: </label> </div>
                <div class='right' style='right: 100px; position: relative'>
                    <a>{{task.job_id}}</a>
                    <!--&nbsp;&nbsp;<a href="">Resubmit</a>这个按钮的函数要改，和原代码逻辑不同-->
                </div>       
                <script type="text/javascript">  
                    var myVar = setInterval(function(){ myTimer() }, 1000);
                    function myTimer() {
                        var d = document.getElementById('num').innerHTML.replace(" seconds", "");
                        var t = Number(d) - 1 ;
                        if (t > 0)
                        {
                            document.getElementById("num").innerHTML = t;
                            d = t
                        }
                        else{
                            clearInterval(myVar);
                        }
                    }
                </script>
                
                <script>
                    $(function() {
                        var job_select=$("#job_select");
                        job_ids = window.localStorage.getItem("prodesign_job_id")
                        if (job_ids) {
                            job_ids = JSON.parse(job_ids);
                            $.each(job_ids, function(key, value) {
                                if ($.trim(key) != "" && key != "{{ task.job_id }}") {
                                    $("<option>" + key + "</option>").appendTo(job_select);
                                }
                            });
                        } else {
                            job_ids = {};
                        }

                        job_ids["{{task.job_id}}"] = 1;
                        window.localStorage.setItem("prodesign_job_id", JSON.stringify(job_ids));

                        $(job_select).on('change', function(e) {
                            var s = e.target;
                            var id = s.options[s.selectedIndex].text;
                            if (id != "") {
                                window.location.href="{{ module }}/checking/" + id ;
                            }
                        });
                    });
                </script>
            </div>
            <br>

            <div class="row">
                <div class="left" style="text-align: left; position: absolute;"><label> Submission Time: </label> </div>
                <div class="right" style="right: 100px; position: relative;">{{ task.time_create }}</div>
            </div>
    {% if task.time_run %}
            <div class="row">
                <div class="left" style="text-align: left; position: absolute;"><label> Running Time: </label> </div>
                <div class="right" style="right: 100px; position: relative;">{{ task.time_run }}</div>
            </div>
    {% endif %}
    {% if task.time_done %}
            <div class="row">
                <div class="left" style="text-align: left; position: absolute;"><label> Finished Time: </label> </div>
                <div class="right" style="right: 100px; position: relative;">{{ task.time_done }}</div>
            </div>
    {% endif %}
{% endif %}
        </div>
        <br>
        <br>
        <!-- End of specification -->
        
        <!-- Waiting for results -->
        <div class="block">
                <table>
                    <tr><th bgcolor="#33ccff"><h4><font color="white">&nbsp Task status</font></h4></th></tr>
                </table>
                <div class="row">
                    <p>    <strong>Your job is currently being processed, please be patient. The results of your job will appear in this browser window!
                    </strong>
                    <br />(You may <a href="javascript:void(0);" title="bookmark" onclick="addFavorite(window.location, document.title);">bookmark</a> this page to view your results later if you wish.)</p>
                </div>

                <div class="row">
                    <div class="left" style="text-align: left; position: absolute;"><label> Current Status:</label></div>
                    <div class="right {{ status_css(task.status) }}"  style="right: 100px; position: relative;">{{ task.status }}</div>
                </div>
{% if task.status != "Done" %}
            <form action="">
                <br> 
                             
                <div class = "row">
                    <div class="left" style="text-align: left; position: absolute;"><label> Next Check:</label></div>
                    <div class="right" style="right: 100px; position: relative;" id="num">30 seconds</div>
                </div>   
                   
                 <br>    
                <div class = "row" style="right: 100px; position: relative;">
                    <div id="check_">
                        <input type="hidden", name="id", value="{{ task.job_id }}"/>
                        <input type="submit" name="check" style="background-color:#00cc99; padding:8px 10px 8px 10px; font-size:12px; color:white" value="Check Now"> </input>
                    </div>
                </div>
            </form>
{% endif %}
        </div>
        <!-- End of waiting -->


        <div class="block">
            <table>
                <tr><th bgcolor="#33ccff"><h4><font color="white">&nbsp Sequence Results</font></h4></th></tr>
            </table>
        <table>
            <tr>
                <div id ="pdb_div" style="float: top; height:280px; width: 280px; position: relative;">
                
                    <script type="text/javascript">
                       $(function() {
                         glviewer = $3Dmol.createViewer("pdb_div", {});
                         $.ajax({
                           url: "{{ module }}/resource/{{ task.job_id }}/relaxed_pdb",
                           dataType: 'text',
                           type:"get",
                           success: function(data) {
                             glviewer.setBackgroundColor(0xf8f8f8);
                             glviewer.addModel(data, 'pdb');
                             glviewer.setStyle({cartoon:{color:'spectrum'}})
                             glviewer.zoomTo();
                             glviewer.render();
                           },
                           error:function(err){
                               console.log(err.statusText);
                               console.log('异常');
                           }
                           
                         });
                       });
                   </script>
                   </div>
                   <a href="{{ module }}/resource/{{ task.job_id }}/relaxed_pdb">Final predicted result by {{ task.job_id }} </a>
            </tr>
            
        </table>
            
        </div>

    <!-- Begin of Status Log -->
    <div class="block">
        <table>
            <tr><th bgcolor="#33ccff"><h4><font color="white">&nbsp Job logs</font></h4></th></tr>
        </table>
        <div class="statuslog">
        {% if job %}{{ task.logs }}{% endif %}
        </div>
    </div>
    <!-- End of Status Log -->
                </div>
                <div class="col-md-4 wow fadeIn" align="center" data-wow-delay="0.3s" >

                    <br>
                    <h4 align="left"><b> SERVER STATUS</b></h4>
                    <table id="jobtable" class="table">
                        <tbody><tr class="{{ status_css('Queuing') }}">
                        <td class="q"></td>
                        <td style="width: 50px; border-right-width: 0px; background-color: pink;" > </td>
                        <td style="text-align: justify; "><font size="2px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Queuing</font></td>
                        <td style="text-align: justify; "><font size="2px">{% if task_status.Queuing %}{{ task_status.Queuing }}{% else %} 0 {% endif %}</font></td>
                        </tr>
                        <tr class="{{ status_css('Running') }}">
                        <td class="r"></td>
                         <td style="width: 10px; border-right-width: 0px; background-color: yellow;" > </td>
                        <td style="text-align: justify; "><font size="2px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Running</font></td>
                        <td style="text-align: justify; "><font size="2px">{% if task_status.Running %}{{ task_status.Running }}{% else %}0{% endif %}</font></td>
                        </tr>
                        <tr class="{{ status_css('Done') }}">
                        <td class="d"></td>
                           <td style="width: 5px; border-right-width: 0px; background-color: green;" > </td>
                        <td style="text-align: justify; "><font size="2px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Done</font></td>
                        <td style="text-align: justify; "><font size="2px">{% if task_status.Done %}{{ task_status.Done }}{% else %}0{% endif %}</font></td>
                        </tr>
                        <tr class="{{ status_css('Error') }}">
                        <td class="e"></td>
                        <td style="width: 5px; border-right-width: 0px; background-color: red;" > </td>
                        <td style="text-align: justify; "><font size="2px">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Error</font></td>
                        <td style="text-align: justify; "><font size="2px">{% if task_status.Error %}{{ task_status.Error }}{% else %}0{% endif %}</font></td>
                        </tr>
                        </tbody>
                    </table>
                    <br>
                    
                    </div>

    </div>

   
        <div class="col-md-4 wow fadeIn" align="center" data-wow-delay="0.3s" >

        </div>
            </div>
        </div>
    </section>
    </div>

{% endblock %}
